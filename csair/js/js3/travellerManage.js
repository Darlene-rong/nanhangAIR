$(() => {
  window.travellerManage = {
    tmTable: [{
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 1 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 2 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, {
      psgId: 222211, //旅客唯一id
      certNum: 222211, //证件
      psgName: 222211, //旅客名字
      isInternational: 0, //0表示国内,只显示国内
      psgType: 0 //0表示成人，1表示儿童，2表示婴儿
    }, ],
    init() {
      var $this = this;
      if (this.windowInit()) {
        this._changCard($(`#${$this.checkVal()}`))
        $this.birthInit($this.checkVal());
        this.tabsInit();
        this.eventInit();
      } else {};

    },

    windowInit() {
      //判断是否在线
      if (!window.userName) {
        // window._yyPlayAlert('登录超时，请重新登录！');
        return false;
      } else {
        return true;
      }
    },
    birthInit(type) {
      //出生日期初始化 根据成人儿童小孩
      console.log(type)
      var date = new Date();
      var y = date.getFullYear();
      var minYear, maxYear;
      if (type == 'adult') {
        //成人
        minYear = y - 150;
        maxYear = y - 12;
      } else if (type == 'child') {
        //儿童
        minYear = y - 12;
        maxYear = y - 2;
      } else if (type == 'baby') {
        //
        minYear = y - 2;
        maxYear = y;
      };
      $(".birthy").html('');
      $(".birthym").html('');
      $(".birthyd").html('');
      $(".js_tm_birth").myDate({
        yearId: `.birthy`,
        monthId: `.birthym`,
        dayId: `.birthyd`,
        defaultDate: "--",
        minYear: minYear,
        maxYear: maxYear
      });
    },
    tabsInit() {
      //表格初始化 和 分页 
      //ajax
      this.tmTable.total = this.tmTable.length;
      this.tm_pageInit(this.tmTable, 1);
    },
    eventInit() {
      //绑定事件初始化
      var $this = this;
      //查询
      $(".js_contect_search").on('click', function () {
        console.log($("#psg_tpye").val(), $("#travelname").val())
      });
      //返回
      $(".js_travel_back").on('click', function () {
        if ($this.windowInit()) {
          $(".js_trave_content").show();
          $(".js_tm_dialog").hide();
          $(".js_travel_tip").html('');
          $("#travelForm")[0].reset();
          $this._changCard($("#adult"))
        }
      });
      //check
      window.bindCheckKeyDown(".js_travel_check");
      // 保存
      $(".js_travel_save").on('click', function () {
        $this.travelToSave();
      });
    },
    travelEdit(type, val, psgtype) {
      //编辑
      //window.loading.show()
      //ajax
      var $this = this;
      var dom = '';
      if ($this.windowInit()) {
        $(".js_trave_content").hide();
        $(".js_tm_dialog").show();
        if (type == 'add') {
          //新增
          $(".js_tdialog_title").html('新增常用旅客');
        } else {
          //修改
          var birth = '1992-10-11';
          $(".js_tdialog_title").html('修改常用旅客信息');
          if (psgtype == '成人') {
            dom = "#adult";
          } else if (psgtype == '儿童') {
            dom = "#child";
          } else if (psgtype == '婴儿') {
            dom = "#baby";
          }
          $this._changCard(dom);
          var data = {
            birthday: "1997-11-09",
            certNum: "43*********65",
            email: null,
            fpCardNo: null,
            fpCompany: null,
            isInternational: "0",
            mobilePhone: "16626443619",
            psgId: 680256164541,
            psgName: "鍛ㄨ搲",
            psgType: "1",
          }
          $this.birthSet(data.birthday)
          for (var key in data) {
            console.log();
            if (key != 'birthday') {
              $(`#${key}`).val(data[key])
            }
          }

        }
      }
    },
    birthSet(date) {
      console.log(date.split('-'));
      $('#birthy').val(date.split('-')[0]);
      $('#birthym').val(date.split('-')[1]);
      $('#birthyd').val(date.split('-')[2]);
    },
    travelToSave() {
      var $this = this;
      $this.travelFormValite();
    },
    travelBlur(type) {
      console.log(type);
      var $this = this;
      var dom = '#' + type;
      var json = {
        psgName: '旅客姓名',
        certNum: '证件号码',
        birthy: '出生日期年',
        birthym: '出生日期月',
        birthyd: '出生日期日',
      };
      let tip = '';
      if (type != 'fpCardNo') {
        if ($(json[type]).val() == '' || $(dom).val() == null) {
          tip = json[type] + '必填';
          $this.tipPlay('.js_travel_tip', 'dom', tip);
          return;
        } else {
          $(".js_travel_tip").html('');
        };
      };
      if (type == 'certNum') {
        if (!$this.yzCartId()) {
          return false;
        }
      };
      if (type == 'mobilePhone' && $("#mobilePhone").val() != '') {
        if (window.checkMobile($(dom).val()) == false) {
          $this.tipPlay('.js_travel_tip', '', '手机号码输入有误，请重新输入！');
          return true;
        }
      } else if (type == 'fpCardNo' && $("#fpCardNo").val() != '') {
        if (window.yzMzNumber($("#fpCardNo").val()) == false) {
          $this.tipPlay('.js_travel_tip', '', '明珠卡号输入格式有误，请重新输入');
        }
      } else if (type == 'email' && $("#email").val() != '') {
        if (!window.isEmail($("#email").val().trim())) {
          $this.tipPlay('.js_common_tip', '', 'E-mail格式输入有误');
        }
      }
    },
    travelFormValite() {
      //表单验证
      var $this = this;
      var formDa = $("#travelForm").serializeArray();
      var checkStatus = $("#tmcheck").is(':checked');
      var type = $this.checkVal();
      if ($("#psgName").val() == '') {
        $this.tipPlay('.js_travel_tip', '#psgName', '旅客姓名不能为空');
        return false;
      };
      if ($("#certNum").val() == '' && type != 'baby') {
        $this.tipPlay('.js_travel_tip', '#certNum', '证件号码不能为空');
        return false;
      } else if (type != 'baby') {
        if (!$this.yzCartId()) {
          return false;
        }
      };
      if ($("#birthy").val() == null) {
        $this.tipPlay('.js_travel_tip', '#birthy', '出生月份不能为空');
      };
      if ($("#mobilePhone").val() != '') {
        if (!window.validateType('istel', $("#mobilePhone").val())) {
          $this.tipPlay('.js_travel_tip', '#mobilePhone', '手机号码格式输入有误');
          return;
        }
      };
      if ($("#email").val() != '') {
        if (!window.validateType('istel', $("#email").val())) {
          $this.tipPlay('.js_travel_tip', '#isemail', '邮箱格式输入有误');
          return;
        }
      };
      if (!checkStatus) {
        $this.tipPlay('.js_travel_tip', '#tmcheck', '请阅读隐私通知并且勾选');
        return false; 
      }
      return true;
    },
    yzCartId() {
      var mark = true;
      var $this = this;
      if ($("#certType").val() == 'IN') {
        //身份证验证
        if (!window.validateType('isCardID', $("#certNum").val())) {
          $this.tipPlay('.js_travel_tip', '#certNum', '身份证输入格式有误');
          mark = false;
        }
      } else if ($("#certType").val() == 'PP') {
        //护照验证
        if (!window.validateType('isPassport', $("#certNum").val())) {
          $this.tipPlay('.js_travel_tip', '#certNum', '护照输入格式有误');
          mark = false;
        }
      }
      return mark;
    },
    // 分页
    checkVal() {
      let type = '';
      $(".js_pstype").each(function (index, val) {
        if ($(val).is(':checked')) {
          type = $(val).val();
        }
      });
      return type;
    },
    _changCard(e) {
      var type = $(e).val();
      this.birthInit(type);
      $(".js_pstype").prop('checked', false);
      $(e).prop('checked', 'checked');
      if (type == 'adult') {
        $(".js_baby").show();
        $(".js_child").show();
      } else if (type == 'child') {
        $(".js_baby").show();
        $(".js_child").hide();
      } else if (type == 'baby') {
        $(".js_baby").hide();
      }
    },
    tipPlay(dom, focusdom, title) {
      $(dom).text(title);
      if (focusdom) {
        $(focusdom).focus();
      }
      // window.playerText(title);
    },
    tm_pageInit(arr, pageNum) {
      let pageSize = 10;
      var $this = this;
      $this.tm_pageContent(0, pageSize)
      $("#js_travel_Page").tzPage(arr.total, {
        num_display_entries: 8, //主体页数
        num_edge_entries: 2, //边缘页数
        current_page: pageNum - 1, //指明选中页码
        items_per_page: pageSize, //每页显示多条条
        prev_text: "上一页",
        next_text: "下一页",
        showGo: false, //显示跳转
        showSelect: false,
        prev_show_always: true,
        next_show_always: true,
        callback: function (pageno) { //会回传两个参数一个当前页，显示的页数
          $this.tm_pageContent(pageno, pageSize)
        }
      });
    },
    tm_pageContent(pageNo, pageSize) {
      var $this = this;
      var tabHTML = '';
      var startIndex = pageNo * pageSize;
      var endIndex = pageSize * (pageNo + 1);
      var newArr = this.tmTable.slice(startIndex, endIndex);
      $.each(newArr, function (index, val) {
        if (val.isInternational == 0) {
          val.isInternational = '国内'
        };
        if (val.psgType == 0) {
          val.psgType = '成人'
        } else if (val.psgType == 1) {
          val.psgType = '儿童'
        } else if (val.psgType == 2) {
          val.psgType = '婴儿'
          val.certType = null;
        }
        tabHTML += `
          <tr>
            <td>${this.psgName}</td>
            <td>${this.isInternational}</td>
            <td>${val.psgType}</td>
            <td>${this.certNum}</td>
            <td>
              <a href="javascript:;" class="btn pc-btn-detail" data-orderno="${this.psgId}" onclick="contactTravel.contactEdit('${this.psgId}')">查看</a>
              <a href="javascript:;" class="btn pc-btn-detail" data-orderno="${this.psgId}" onclick="travellerManage.travelEdit('edit','${this.psgId}','${val.psgType}')">修改</a>
              <a href="javascript:;" class="btn pc-btn-detail" data-orderno="${this.psgId}" onclick="contactTravel.contactDel('${this.psgId}','${this.psgName}','${this.certType}','${this.certNum}')">删除</a>
            </td>
          </tr>
        `
      });
      $(".js_tavel_table").html(tabHTML);
    }
  };
  travellerManage.init();
})